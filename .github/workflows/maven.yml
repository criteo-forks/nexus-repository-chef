name: Java CI with Maven
on:
 push:
   tags: [ "v*" ]
 pull_request:
   branches: [ "main" ]
jobs:
 build:
   runs-on: ubuntu-latest
   steps:
   - uses: actions/checkout@v3
   - name: install packages
     run: sudo apt install -y openjdk-8-jdk
   - name: set java 8 as default
     run: sudo update-java-alternatives -s $(sudo update-java-alternatives -l | grep '1\.8' | cut -d " " -f1) || echo '.'
   - uses: hb0730/maven-action@v1.0.2
   - name: build and package
     run: mvn clean package -PbuildKar --file pom.xml
   - name: version
     run: echo "version=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" | tee -a $GITHUB_OUTPUT
     id: version
   - name: release
     if: startsWith(github.ref, 'refs/tags/')
     uses: actions/create-release@v1
     id: create_release
     with:
       draft: false
       prerelease: false
       release_name: ${{ github.ref_name }}
       tag_name: ${{ github.ref }}
     env:
       GITHUB_TOKEN: ${{ github.token }}
   - name: upload kar artifact
     if: startsWith(github.ref, 'refs/tags/')
     uses: actions/upload-release-asset@v1
     env:
       GITHUB_TOKEN: ${{ github.token }}
     with:
       upload_url: ${{ steps.create_release.outputs.upload_url }}
       asset_path: ./target/nexus-repository-chef-${{ steps.version.outputs.version }}-bundle.kar
       asset_name: nexus-repository-chef-${{ steps.version.outputs.version }}-bundle.kar
       asset_content_type: application/zip
